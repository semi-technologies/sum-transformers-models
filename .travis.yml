language: python
python: 3.9
env:
  global:
  - LOCAL_REPO: sum-transformers
  - REMOTE_REPO: semitechnologies/sum-transformers
  - secure: "J792kfQECMqvqbWUpUCrquDrj8bFtP9LaKNND23asryQYX5Pj8Pi2nFoxIw5D3ypV59BCOUiI5ofxxLMGYBpM6Qi2lQvgGqjMxTEQEBYchXnYyWLLfh68CL/DAt65rOjZgtDDG58JXs3nUcgbEBQ5E8JR5kYEaZXI6D6YdAuD3RbpTulVSIG5rXa1Wv/4U46/AAxgcNlARfiecElPY2hzhLrDHRZJ2Xyh2hfkZCTtCcEktG6qrmOayfydV2S5fKyBRVQ3iwLEht8zavl91e1dWHOJvOtNkjFZlCM5L3+1fhwpcoX9YDpruXnbyUc73AohuSceGban/Wd9KlptNqMyFQ7xqiIOm/00OvnDSvVeg9o/6iMOqNgFSddi/0zw/pE+z6MHfRDir0gqyWb5AiX596vLerKZsx9DMCuacXmVi3ClZt0Vn/u3w0R9+kzW7WuYThPwgHYOM/XJJXgsSeeKTlFCntN4G+4J2TA0BgoR7pdRrVNbhA9z2GDgZ7KAHoC1GMg5GuD2mV3rgFwsaU8/mcS4hywYrYOZTmgSAd5Vxii1ZLN2khji/WvFsMtuMO68TtUDhGcqbZVusbhdQrJRbDwNiJXjOZcUTLCSmjcER2ydCKP61frq4WVc+Ns/n+HxQMtXHgZKrkaMgttsx9YEb2MYWcVxTfwFSBiU52IDd8="
  - secure: "gtbP0ddAjGQAxNEPXLwmZhfcSnijUn2W2VUyxzULKjWPyFX8kFwcL7Jo0NR9d/mo/b3m/UZ1BwrVQlpUwYtsvJEM9GRp9iUyeYbCPPf7d+H8Z3DfY6rOAyvvMISCCtGGEVapvqYo3WjxB/L43DxNz/Zw0Ew4U+Q1Vccl7xgrBMi6xMFMV9Ki0cbcVBOzO2y1pkA6O+v9esF85igQ/HuDGw5SzuXGJKj902E2Qp/SrCszLYVscRcFk++rf6lFocVYsdjOLt6gxAkh2ATTe1Gn2rxjoqPrQGas51K1dL5WiSF0aNAJgSiSL7xNiyuiawP9fsDyNmeRHTQEHiReM5x5vddqCB9RbSuR/O+5pTbbriQCPUA0QKH14vf5WQebH9sX1qrZtO1chBDbnABR9F2sZ7qUOl83391N+Wb3+ecYlfudm96zP9PjuCPuOuTuCMGoOMnClE5xSVPNcGSOYUyTk5GWyuLwptZQoPMZYOkBnogmSqVv5uOoY4f1qbcB76E+N8HZqzms37zEBz/9Zl4w0HasPl+TtvV4rkaTO7Pq3mXi7OYwGWjcSA3ztgpDUCjFyYoQU7vBlXF6+ibAa6CuEDNTeayxuca4OozyRjaQt7dHCQTqrXNMiD3rKDfk9VOxWEktBVEvEC3/ICvAQdF0+f0AJsyCqrtMs97V3XEd+Nw="



install: echo skipping default travis install script
jobs:
  include:
    # always run test, etc. for this model
    # Commented bc it fails to build a docker image on travis
    # - env:
    #     MODEL_NAME: google/pegasus-xsum
    #     MODEL_TAG_NAME: google-pegasus-xsum
    #   stage: buildanddeploy

    - env:
        MODEL_NAME: facebook/bart-large-cnn
        MODEL_TAG_NAME: facebook-bart-large-cnn
      stage: buildanddeploy

    - env:
        MODEL_NAME: facebook/bart-large-cnn
        MODEL_TAG_NAME: facebook-bart-large-cnn
        ONNX_RUNTIME: true
      stage: buildanddeploy

    - name: Build the base for custom images
      script: GIT_BRANCH=$TRAVIS_BRANCH GIT_TAG=$TRAVIS_TAG GIT_PULL_REQUEST=$TRAVIS_PULL_REQUEST cicd/build_custom_base.sh
      stage: postbuild

script:

- cicd/build.sh || travis_terminate 1

- cicd/test.sh || travis_terminate 1

- |-
  if [ -n "$DOCKER_PASSWORD" ]
  then
    # Push docker image
    GIT_BRANCH=$TRAVIS_BRANCH \
    GIT_TAG=$TRAVIS_TAG \
    GIT_PULL_REQUEST=$TRAVIS_PULL_REQUEST \
    travis_wait 180 cicd/docker_push.sh || travis_terminate 1
  else
    # Skip pushing docker image
    echo "Skipping docker image push step. Tests passed."
    travis_terminate 0
  fi
  
before_install: 
  # install a newer docker version which supports buildx
  - sudo rm -rf /var/lib/apt/lists/*
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) edge"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  - mkdir -vp ~/.docker/cli-plugins/
  - curl --silent -L "https://github.com/docker/buildx/releases/download/v0.3.0/buildx-v0.3.0.linux-amd64" > ~/.docker/cli-plugins/docker-buildx
  - chmod a+x ~/.docker/cli-plugins/docker-buildx

before_script:
  # login to docker at the very beginning, so we don't run into rate-limiting|-
- |-
  if [ -n "$DOCKER_PASSWORD" ]
  then
    echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  fi

# currently the latest available - so we can install the latest docker
dist: bionic
